groups:
  - name: titan-aas.availability
    rules:
      - alert: TitanAASDown
        expr: up{job="titan-aas"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Titan-AAS is down"
          description: "Titan-AAS instance {{ $labels.instance }} has been down for more than 1 minute."

      - alert: TitanAASHighErrorRate
        expr: |
          sum(rate(http_requests_total{job="titan-aas", status=~"5.."}[5m]))
          / sum(rate(http_requests_total{job="titan-aas"}[5m])) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate on Titan-AAS"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)."

      - alert: TitanAASHealthCheckFailing
        expr: titan_aas_health_status != 1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Titan-AAS health check failing"
          description: "Health check for {{ $labels.instance }} is failing."

  - name: titan-aas.latency
    rules:
      - alert: TitanAASHighLatencyP50
        expr: |
          histogram_quantile(0.50, sum(rate(http_request_duration_seconds_bucket{job="titan-aas"}[5m])) by (le)) > 0.1
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High p50 latency on Titan-AAS"
          description: "p50 latency is {{ $value | humanizeDuration }} (threshold: 100ms)."

      - alert: TitanAASHighLatencyP99
        expr: |
          histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket{job="titan-aas"}[5m])) by (le)) > 1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High p99 latency on Titan-AAS"
          description: "p99 latency is {{ $value | humanizeDuration }} (threshold: 1s)."

      - alert: TitanAASSlowQueries
        expr: |
          histogram_quantile(0.95, sum(rate(db_query_duration_seconds_bucket{job="titan-aas"}[5m])) by (le)) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Slow database queries on Titan-AAS"
          description: "p95 query latency is {{ $value | humanizeDuration }} (threshold: 500ms)."

  - name: titan-aas.cache
    rules:
      - alert: TitanAASLowCacheHitRate
        expr: |
          sum(rate(cache_hits_total{job="titan-aas"}[5m]))
          / (sum(rate(cache_hits_total{job="titan-aas"}[5m])) + sum(rate(cache_misses_total{job="titan-aas"}[5m]))) < 0.8
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Low cache hit rate on Titan-AAS"
          description: "Cache hit rate is {{ $value | humanizePercentage }} (threshold: 80%)."

      - alert: TitanAASRedisConnectionError
        expr: redis_up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Redis connection error"
          description: "Cannot connect to Redis."

  - name: titan-aas.database
    rules:
      - alert: TitanAASPostgresConnectionError
        expr: pg_up{job="postgres"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL connection error"
          description: "Cannot connect to PostgreSQL."

      - alert: TitanAASDbConnectionPoolExhausted
        expr: |
          db_pool_connections_active{job="titan-aas"}
          / db_pool_connections_max{job="titan-aas"} > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Database connection pool near exhaustion"
          description: "Connection pool is {{ $value | humanizePercentage }} utilized."

      - alert: TitanAASDbConnectionPoolExhaustedCritical
        expr: |
          db_pool_connections_active{job="titan-aas"}
          / db_pool_connections_max{job="titan-aas"} >= 1
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Database connection pool exhausted"
          description: "No available database connections."

  - name: titan-aas.resources
    rules:
      - alert: TitanAASHighMemoryUsage
        expr: |
          process_resident_memory_bytes{job="titan-aas"}
          / (1024 * 1024 * 1024) > 1.5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage on Titan-AAS"
          description: "Memory usage is {{ $value | humanize1024 }}B."

      - alert: TitanAASHighCPUUsage
        expr: |
          rate(process_cpu_seconds_total{job="titan-aas"}[5m]) > 0.8
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage on Titan-AAS"
          description: "CPU usage is {{ $value | humanizePercentage }}."

  - name: titan-aas.events
    rules:
      - alert: TitanAASEventQueueBacklog
        expr: event_queue_size{job="titan-aas"} > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Event queue backlog on Titan-AAS"
          description: "Event queue has {{ $value }} pending events."

      - alert: TitanAASEventQueueBacklogCritical
        expr: event_queue_size{job="titan-aas"} > 10000
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Critical event queue backlog"
          description: "Event queue has {{ $value }} pending events. System may be overwhelmed."

  - name: titan-aas.security
    rules:
      - alert: TitanAASHighAuthFailureRate
        expr: |
          sum(rate(http_requests_total{job="titan-aas", status="401"}[5m]))
          / sum(rate(http_requests_total{job="titan-aas"}[5m])) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High authentication failure rate"
          description: "Authentication failure rate is {{ $value | humanizePercentage }}. Possible credential stuffing or misconfiguration."

      - alert: TitanAASHighForbiddenRate
        expr: |
          sum(rate(http_requests_total{job="titan-aas", status="403"}[5m]))
          / sum(rate(http_requests_total{job="titan-aas"}[5m])) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High authorization failure rate"
          description: "Authorization failure rate is {{ $value | humanizePercentage }}. Check RBAC/ABAC configuration or potential unauthorized access attempts."

      - alert: TitanAASHighRateLimitRate
        expr: |
          sum(rate(http_requests_total{job="titan-aas", status="429"}[5m]))
          / sum(rate(http_requests_total{job="titan-aas"}[5m])) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High rate limiting"
          description: "Rate limiting is affecting {{ $value | humanizePercentage }} of requests. Consider scaling or adjusting limits."

      - alert: TitanAASSecurityHeadersMissing
        expr: |
          absent(http_response_headers_total{job="titan-aas", header="x-content-type-options"})
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Security headers not being set"
          description: "Security headers middleware may not be enabled."

  - name: titan-aas.slo
    rules:
      - alert: TitanAASSLOAvailabilityViolation
        expr: |
          (1 - sum(rate(http_requests_total{job="titan-aas", status!~"5.."}[1h]))
          / sum(rate(http_requests_total{job="titan-aas"}[1h]))) > 0.001
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "SLO availability violation"
          description: "Error rate over 1 hour is {{ $value | humanizePercentage }}, exceeding 0.1% SLO target."

      - alert: TitanAASSLOLatencyViolation
        expr: |
          histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket{job="titan-aas"}[1h])) by (le)) > 0.1
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "SLO latency violation"
          description: "p99 latency over 1 hour is {{ $value | humanizeDuration }}, exceeding 100ms SLO target."

      - alert: TitanAASErrorBudgetBurnRate
        expr: |
          sum(rate(http_requests_total{job="titan-aas", status=~"5.."}[1h]))
          / sum(rate(http_requests_total{job="titan-aas"}[1h])) > 0.01
        for: 1h
        labels:
          severity: critical
        annotations:
          summary: "Error budget burn rate high"
          description: "Error rate is {{ $value | humanizePercentage }} over the last hour. Monthly error budget may be exhausted."

  - name: titan-aas.leader
    rules:
      - alert: TitanAASNoLeader
        expr: |
          absent(titan_leader_status{job="titan-aas"} == 1)
          or count(titan_leader_status{job="titan-aas"} == 1) == 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "No Titan-AAS leader elected"
          description: "No instance has leader status. Singleton tasks may not be running."

      - alert: TitanAASMultipleLeaders
        expr: count(titan_leader_status{job="titan-aas"} == 1) > 1
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Multiple Titan-AAS leaders detected"
          description: "{{ $value }} instances have leader status. Split-brain condition may exist."

      - alert: TitanAASLeaderElectionStale
        expr: |
          time() - titan_leader_last_renewal_timestamp{job="titan-aas"} > 60
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Leader election renewal stale"
          description: "Leader lock has not been renewed in {{ $value | humanizeDuration }}."

  - name: titan-aas.capacity
    rules:
      - alert: TitanAASApproachingConnectionLimit
        expr: |
          pg_stat_activity_count{job="postgres"}
          / pg_settings_max_connections{job="postgres"} > 0.8
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Approaching PostgreSQL connection limit"
          description: "Using {{ $value | humanizePercentage }} of max connections. Consider scaling."

      - alert: TitanAASRedisMemoryHigh
        expr: |
          redis_memory_used_bytes{job="redis"}
          / redis_memory_max_bytes{job="redis"} > 0.8
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Redis memory usage high"
          description: "Redis is using {{ $value | humanizePercentage }} of max memory."

      - alert: TitanAASStorageSpaceLow
        expr: |
          (pg_database_size_bytes{job="postgres", datname="titan"}
          / pg_tablespace_size_bytes{job="postgres"}) > 0.8
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "Database storage space low"
          description: "Database is using {{ $value | humanizePercentage }} of available storage."
